<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../public/css/style.css">
    <link rel="stylesheet" href="../../public/css/sortear_style.css">
    <title>Roleta de Produtos</title>
</head>
<body>
    <header id="cabecalhoIntermediario">
        <img src="../../public/img/Logo.png" alt="Logo" id="logo">
        <h1>Sortear</h1>
        <a href="homePage.html" target="_self"><i class="fa-solid fa-x botaoVoltar"></i></a>
    </header>
    <div class="container">
        <div class="roleta-container">
            <div class="ponteiro"></div>
            <div class="roleta" id="roleta">
                <div class="fatia" data-produto="0">
                    <div class="fatia-emoji">üç™</div>
                    <div class="fatia-texto">Cookie</div>
                </div>
                <div class="fatia" data-produto="1">
                    <div class="fatia-emoji">üß∏</div>
                    <div class="fatia-texto">Boneca de Croch√™</div>
                </div>
                <div class="fatia" data-produto="2">
                    <div class="fatia-emoji">üê±</div>
                    <div class="fatia-texto">Touca para Gatos</div>
                </div>
                <div class="fatia" data-produto="3">
                    <div class="fatia-emoji">üç´</div>
                    <div class="fatia-texto">Brigadeiro</div>
                </div>
            </div>
            <div class="centro">üéØ</div>
        </div>

        

        <div class="resultado" id="resultado">
            <p>Clique em "GIRAR ROLETA" para descobrir seu produto!</p>
        </div>

        <button class="btn-girar" id="btnGirar" onclick="girarRoleta()">
            GIRAR ROLETA
        </button>

        <div class="historico">
            <h3>üìã Hist√≥rico de Resultados</h3>
            <div class="historico-lista" id="historico">
                <p style="text-align: center; opacity: 0.7;">Nenhum resultado ainda...</p>
            </div>
        </div>
    </div>
    <footer>    
        <a href="pesquisar.html" target="_self"><i class="fa-solid fa-magnifying-glass botaoPesquisar"></i></a>
        <a href="selecionarChat.html" target="_self"><i class="fa-solid fa-comment botaoChat"></i></a>
        <a href="calendario.html" target="_self" id="menuSelecionado"><p class="botaoData">SEG</p></a>
        <a href="favoritos.html" target="_self"><i class="fa-solid fa-heart botaoFavoritos"></i></a>
        <a href="menu_bar.html" target="_self"><i class="fa-solid fa-bars botaoMenuBar"></i></a>
    </footer>
    <script>
        // Array de produtos na ordem exata das fatias no HTML
        const produtos = [
            { nome: "Cookie", emoji: "üç™", descricao: "Biscoito crocante e delicioso" },
            { nome: "Boneca de Croch√™", emoji: "üß∏", descricao: "Artesanato feito com carinho" },
            { nome: "Touca para Gatos", emoji: "üê±", descricao: "Acess√≥rio fofo para seu felino" },
            { nome: "Brigadeiro", emoji: "üç´", descricao: "Doce tradicional brasileiro irresist√≠vel" }
        ];

        let girando = false;
        let historico = [];
        let rotacaoAtual = 0; // Mant√©m controle da rota√ß√£o acumulada

        function girarRoleta() {
            if (girando) return;

            girando = true;
            const btnGirar = document.getElementById('btnGirar');
            const roleta = document.getElementById('roleta');
            const resultado = document.getElementById('resultado');

            btnGirar.disabled = true;
            btnGirar.textContent = 'GIRANDO...';
            resultado.innerHTML = '<p>üé≤ Girando...</p>';

            // Sorteia o produto
            const indiceSorteado = Math.floor(Math.random() * produtos.length);
            const produtoSorteado = produtos[indiceSorteado];

            // Calcula onde o ponteiro deve parar
            // Assumindo que a primeira fatia (Cookie) come√ßa em 0¬∞ e vai no sentido hor√°rio
            // Cada fatia ocupa 90¬∞ (360¬∞/4)
            const angulosPorFatia = 360 / produtos.length; // 90¬∞
            
            // √Çngulo central de cada fatia (onde queremos que o ponteiro pare)
            const anguloAlvo = (indiceSorteado * angulosPorFatia) + (angulosPorFatia / 2);
            
            // Adiciona um pequeno offset aleat√≥rio para parecer natural
            const offsetAleatorio = (Math.random() - 0.5) * 30; // ¬±15¬∞
            
            // Adiciona v√°rias voltas completas
            const voltasCompletas = 5 + Math.random() * 3; // 5-8 voltas
            
            // Calcula a rota√ß√£o final
            // Como o ponteiro est√° no topo (0¬∞) e queremos que ele aponte para o produto,
            // precisamos girar at√© que o produto fique na posi√ß√£o do ponteiro
            const anguloFinalDesejado = anguloAlvo + offsetAleatorio;
            
            // A rota√ß√£o total √©: rota√ß√£o atual + voltas completas + ajuste para chegar no √¢ngulo desejado
            // Invertemos o √¢ngulo porque giramos no sentido hor√°rio mas queremos o produto na posi√ß√£o do ponteiro
            const novaRotacao = rotacaoAtual + (voltasCompletas * 360) + (360 - anguloFinalDesejado);

            console.log('Debug Detalhado:', {
                indiceSorteado: indiceSorteado,
                produto: produtoSorteado.nome,
                angulosPorFatia: angulosPorFatia,
                anguloAlvo: anguloAlvo,
                offsetAleatorio: offsetAleatorio,
                anguloFinalDesejado: anguloFinalDesejado,
                rotacaoAtual: rotacaoAtual,
                voltasCompletas: voltasCompletas,
                novaRotacao: novaRotacao,
                rotacaoFinal: novaRotacao % 360
            });

            // Aplica a rota√ß√£o com anima√ß√£o
            roleta.style.transition = 'transform 3s cubic-bezier(0.25, 0.1, 0.25, 1)';
            roleta.style.transform = `rotate(${novaRotacao}deg)`;
            
            // Atualiza a rota√ß√£o atual para pr√≥ximas rodadas
            rotacaoAtual = novaRotacao;

            // Mostra o resultado ap√≥s a anima√ß√£o
            setTimeout(() => {
                mostrarResultado(produtoSorteado);
                adicionarAoHistorico(produtoSorteado);
                
                girando = false;
                btnGirar.disabled = false;
                btnGirar.textContent = 'GIRAR NOVAMENTE';
                
                // Verifica se a anima√ß√£o parou no lugar certo
                verificarPosicaoFinal(indiceSorteado);
            }, 3000);
        }

        // Fun√ß√£o para verificar se a anima√ß√£o parou no lugar correto (debug)
        function verificarPosicaoFinal(indiceEsperado) {
            const anguloFinal = rotacaoAtual % 360;
            const anguloNormalizado = (360 - anguloFinal) % 360;
            const fatiaCalculada = Math.floor(anguloNormalizado / 90);
            
            console.log('Verifica√ß√£o:', {
                indiceEsperado: indiceEsperado,
                anguloFinal: anguloFinal,
                anguloNormalizado: anguloNormalizado,
                fatiaCalculada: fatiaCalculada,
                correto: fatiaCalculada === indiceEsperado ? '‚úÖ' : '‚ùå'
            });
        }

        function mostrarResultado(produto) {
            const resultado = document.getElementById('resultado');
            resultado.innerHTML = `
                <div>
                    <h2>üéâ Parab√©ns!</h2>
                    <p>${produto.emoji} <strong>${produto.nome}</strong></p>
                    <p style="font-size: 0.9rem; margin-top: 5px;">${produto.descricao}</p>
                </div>
            `;
        }

        function adicionarAoHistorico(produto) {
            const agora = new Date();
            const horario = agora.toLocaleTimeString('pt-BR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });

            historico.unshift({
                produto: produto,
                horario: horario
            });

            if (historico.length > 10) {
                historico = historico.slice(0, 10);
            }

            atualizarHistorico();
        }

        function atualizarHistorico() {
            const historicoDiv = document.getElementById('historico');
            
            if (historico.length === 0) {
                historicoDiv.innerHTML = '<p style="text-align: center; opacity: 0.7;">Nenhum resultado ainda...</p>';
                return;
            }

            const historicoHTML = historico.map(item => `
                <div class="historico-item">
                    <strong>${item.horario}</strong> - ${item.produto.emoji} ${item.produto.nome}
                </div>
            `).join('');

            historicoDiv.innerHTML = historicoHTML;
        }

        // Fun√ß√£o para calibrar manualmente (use no console se necess√°rio)
        function calibrarRoleta(indice) {
            const roleta = document.getElementById('roleta');
            const angulo = indice * 90;
            roleta.style.transition = 'transform 1s ease';
            roleta.style.transform = `rotate(${360 - angulo}deg)`;
            console.log(`Testando produto ${indice}: ${produtos[indice].nome} - √Çngulo: ${angulo}¬∞`);
        }

        // Adiciona efeito de hover nas fatias
        document.addEventListener('DOMContentLoaded', function() {
            const fatias = document.querySelectorAll('.fatia');
            fatias.forEach(fatia => {
                fatia.addEventListener('mouseenter', function() {
                    if (!girando) {
                        this.style.transform += ' scale(1.05)';
                    }
                });
                
                fatia.addEventListener('mouseleave', function() {
                    if (!girando) {
                        this.style.transform = this.style.transform.replace(' scale(1.05)', '');
                    }
                });
            });

            // Adiciona fun√ß√£o de calibra√ß√£o ao objeto window para debug
            window.calibrarRoleta = calibrarRoleta;
            console.log('Para testar manualmente, use: calibrarRoleta(0), calibrarRoleta(1), etc.');
        });
    </script>
    <script src="https://kit.fontawesome.com/2d311d7657.js" crossorigin="anonymous"></script>
</body>
</html>
